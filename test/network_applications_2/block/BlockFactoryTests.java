package network_applications_2.block;

import network_applications_2.message.Message;
import network_applications_2.message.MessageFactory;
import network_applications_2.message.MessageFormatException;
import network_applications_2.utilities.KeyGenerator;
import network_applications_2.utilities.KeyManager;
import org.junit.BeforeClass;
import org.junit.Test;

import java.security.KeyPair;
import java.util.*;

import static org.junit.Assert.*;

public class BlockFactoryTests {

    private static SortedSet<Message> messages;
    private static List<KeyPair> users;
    private static String blockString;

    @BeforeClass
    public static void initialize() throws MessageFormatException {
        users = new ArrayList<>();
        for (int i = 0; i < 10; i++) {
            users.add(KeyGenerator.generate());
        }
        messages = new TreeSet<>();
        messages.add(MessageFactory.create(users.get(0), 1000));
        for (int i = 1; i < 10; i++) {
            messages.add(MessageFactory.create(users.get(i - 1),
                    KeyManager.convertToString(users.get(i).getPublic()),
                    1000 - 100 * i));
        }
        blockString = "1524852989699,null,0000578EB0992ADCD8B3A688266248063D6DB39B3377E502D124DC1D6CFE8956,9261476567759882,{1524852989659,30819F300D06092A864886F70D010101050003818D00308189028181008F1A503CCF89C284A601C2A59D32CE7A9A873698ACF1744F5F5F41DE42F84C57F1AB6D14281392A7119E19E55496B18D9C06CA059AFC7AF8746BD700AB53C16BAD4F64C1E3EBE42D55E5DF6682A597714C468FF415CD7F32C507B4F479CB3E2C58DCC48F35B012ABBBDAC7788BEB11DE2617A99187B2438AF9AB38E41515D43B0203010001,1000.000000,6F68C66E69C333A757DDBE711D25C1D74EEB026BC7EC8D54B2BFCC120B7A0D5F,11E7542FF6BC040882F2F9EA9AB16920E0ECF4C63B2CF50F263447F8A3079FA29A188972484E7139C5F8CCD5C29B4967DDBEF2A1E1EDDFA2D70D0E4477EA9F1F222BC5C72840B8B0702A5D8BEF3558C4F78164E9B48C810ADCEA701306CB10C78E4BB961F50D361111BC237F8326DE688121492291E5F0D22D9593578D5805C6;1524852989675,30819F300D06092A864886F70D010101050003818D00308189028181008F1A503CCF89C284A601C2A59D32CE7A9A873698ACF1744F5F5F41DE42F84C57F1AB6D14281392A7119E19E55496B18D9C06CA059AFC7AF8746BD700AB53C16BAD4F64C1E3EBE42D55E5DF6682A597714C468FF415CD7F32C507B4F479CB3E2C58DCC48F35B012ABBBDAC7788BEB11DE2617A99187B2438AF9AB38E41515D43B0203010001,30819F300D06092A864886F70D010101050003818D0030818902818100902767CFAD1FA4242CA73A4A285E3C864356F17BCFD7E294F8DB6A622E70C3C0E843CF7B9769A8908FA11715EC105B60DF066D77BAA5B657D200D265555BF95058EF3CC8875614350E4AFE418560282A3779DFD7859AFF581432ABDD5F259354806EE63C76F11F3BAF1A95A19A7A6DD4586E50766E0A0702E134BAF13991C8C30203010001,900.000000,821C890FADD60969B2CCC0C75830739AE7140E2BD6083E8AC6FD5D8EEF5F5F6A,6B9E00208A06D1CC39E97257D0138BD2BF3D98439B81B4D10BBC0E0161C61F8647379887822733ED6C76C00DF6D3EDE1DFE2D75F4C4B69E892109E93FF0B8A4D38819F791EE66042010B15BD8508D70249F07432C1EA07AAB16785F3B2F53669667AE7B2FA9BAD174DC408CC9CC35F4DE95A51EA8A42DC82CD923F3A24A9C7C7;1524852989677,30819F300D06092A864886F70D010101050003818D0030818902818100902767CFAD1FA4242CA73A4A285E3C864356F17BCFD7E294F8DB6A622E70C3C0E843CF7B9769A8908FA11715EC105B60DF066D77BAA5B657D200D265555BF95058EF3CC8875614350E4AFE418560282A3779DFD7859AFF581432ABDD5F259354806EE63C76F11F3BAF1A95A19A7A6DD4586E50766E0A0702E134BAF13991C8C30203010001,30819F300D06092A864886F70D010101050003818D0030818902818100DF79D482B39EB5EAE22401147643A956560552E9B05D205B17A987119CF72C343352682B90078F121D8A2664A84E1372187D455BB2ACAB537DEE04DC2AC4483241D071A2EF2DCD398C7DF7E7D5D38A469165AD2DAAA4EBFB964811B36BA1FF7ED809D3E1B176C092EF4D55224D69AE64B719B340B1DA03DCC9F340E27E8B55930203010001,800.000000,B8D111A58423755172CE1E455FBCBEFC88DC26948021D36A4B3CA522F19804C2,626C152E907C8FD66167162C137FD6303CAE934A879FF340F14C03E43EC0260CF45698EC89000EB3C8BD3F019B4898DC747AF9D7CAF2CEBD8208820690DA86096CC7DBC24537F6782CD95B5D70F7F7FB35519C0A4005751E8396A8F453264D19477A24ED08ECCBE1C6056B9BB423AEA3D75CF698111134AFB1EA95D3D55E90F7;1524852989679,30819F300D06092A864886F70D010101050003818D0030818902818100DF79D482B39EB5EAE22401147643A956560552E9B05D205B17A987119CF72C343352682B90078F121D8A2664A84E1372187D455BB2ACAB537DEE04DC2AC4483241D071A2EF2DCD398C7DF7E7D5D38A469165AD2DAAA4EBFB964811B36BA1FF7ED809D3E1B176C092EF4D55224D69AE64B719B340B1DA03DCC9F340E27E8B55930203010001,30819F300D06092A864886F70D010101050003818D0030818902818100BC36EBB3DBCBF6001CB434C106F485B99EC2705E69249816A0138BAD048F931E9E29F1089CDFFD6C56FD7ED4F9F791D72E4365FE405A24E7016E5B7CD086CDFC0B1529E76767CD79973C013A67BD7C64A38E4B188EEBAA7099ADE036F5DDC949A52334E5425186C30A9F336C2F071A9D6732D77D5A600D3E8D29216E9275A1890203010001,700.000000,0F8F8130218AEA8C148D785AE4482D2D042C652878C33999711B25874B7A86CE,13AC0360E4E8C301C9B83BB43D9636F37C69E306505DE970E4594AD094A1D2E681BA36828614968FD53773ADE5674595378A264C026F4003B1FCDAE29E2124A1180081F0EBC6164AB472F7C0A55EDF7A85485195486A41515C7B3E14814E58B928BB78372610F3551921B1BD7AB0B871669B0CFB01BE73B129BCF5A1793527D7;1524852989682,30819F300D06092A864886F70D010101050003818D0030818902818100BC36EBB3DBCBF6001CB434C106F485B99EC2705E69249816A0138BAD048F931E9E29F1089CDFFD6C56FD7ED4F9F791D72E4365FE405A24E7016E5B7CD086CDFC0B1529E76767CD79973C013A67BD7C64A38E4B188EEBAA7099ADE036F5DDC949A52334E5425186C30A9F336C2F071A9D6732D77D5A600D3E8D29216E9275A1890203010001,30819F300D06092A864886F70D010101050003818D00308189028181009C099E9CD5A2DEA2664CA0124C7BA8DE202D590E54EAAFC74A590C9D04FFB4206C8A1D0EFF7A1AEB95714760F37CBD5852441AF82ECA48DB0C7CC7B327D6AE345A9436E85DF521DB7BE68DD080BD8245A888C5F15087706C8A671B4D7B7D5A98CD3DA4E03A4ECD4552933E6CD322E8C3623996F65D4E0C849B7D285C0B0305570203010001,600.000000,7EC3C3C198724C5634DC6A6CA203F6FFC1DF99E5E38C78E27D4B4916FD25D70E,2444D9B86233D2F5DF2856F22A42C6A8480BA6DE993D929F4B98B1F6A1D1999F14DB1245236E924B12AD52596C2F546891EB6E8C14569FB5D5B76D7263A1A56E3734CBEF2B3CFD7D42F738D4209558F77F49E82AB6BAB6D44CF6695949C26EA09A6C702E858710FF24FB9B14B7D1AEA5B49306B0292E86B741B7B70E5C2E35AC;1524852989684,30819F300D06092A864886F70D010101050003818D00308189028181009C099E9CD5A2DEA2664CA0124C7BA8DE202D590E54EAAFC74A590C9D04FFB4206C8A1D0EFF7A1AEB95714760F37CBD5852441AF82ECA48DB0C7CC7B327D6AE345A9436E85DF521DB7BE68DD080BD8245A888C5F15087706C8A671B4D7B7D5A98CD3DA4E03A4ECD4552933E6CD322E8C3623996F65D4E0C849B7D285C0B0305570203010001,30819F300D06092A864886F70D010101050003818D0030818902818100BC2E3D5A701A64105050898BA284CEEC15A9B5A360D1CFB445AAF41F454A58854697CE1FFA372D24B9D7EE096986A2229780095C9DB0A71721895E8F0804C76A12A7B03EF2392CD77FC79E9F9ACE41D10C7495F9949CEAD995D8AE71660C04647186D86CB86C9F79EE9CB9633FA9B4F1B462BE75E5210B4E4A8768FEB68734210203010001,500.000000,89DDB122E4CF6DB8D6D91171455A74EC19C587EC7A5476021633ACEF4AA84CE2,03BD636AB755E500787A734D80638152499F7BBDB618F4240536FF5324D9F92047D1B77DE2DBCF27F06788B610F498EA466A7EC4059AF97389A525436ED8B6062A445879261F88DF3F6E54A46A5BCC545C68C5EC5DBCC8468E24431CB2D975F79675AF34171B8FE61B25FAAAC1877649B4C4990DB8CB9F8EEFA2EB4CBC7D29B5;1524852989687,30819F300D06092A864886F70D010101050003818D0030818902818100BC2E3D5A701A64105050898BA284CEEC15A9B5A360D1CFB445AAF41F454A58854697CE1FFA372D24B9D7EE096986A2229780095C9DB0A71721895E8F0804C76A12A7B03EF2392CD77FC79E9F9ACE41D10C7495F9949CEAD995D8AE71660C04647186D86CB86C9F79EE9CB9633FA9B4F1B462BE75E5210B4E4A8768FEB68734210203010001,30819F300D06092A864886F70D010101050003818D0030818902818100873BADB1A8A78321302550D26FA4F80E56934B5903A1FD8C632C3B1FA77AB10B4DF5864F4CA56B1FA61CF3A9917AFD518D2BEF6BC14320972E8E56DCB58F8AE4E5C9A3B641DCEB17D219DE3A0E1827B62D6E919A85D8FC53C8FAB1CE159C0D7604C1B47898DC9D4D5DE016A6573E8446E6D6304FB8BF2BD11C119F53F80EFAEF0203010001,400.000000,1A738338D257FB606AD68556DA27B8FB294BD5269FB730EAAE16F47679FFF9DE,05953484A249B819828ACDA5418FAF265A90BDF7D1CAD407072661E05440663D51FB3032C36834C74FD4D3C11D35CF3F27599C5E8A55A0D050102EA3A2DA5CC0DC57918EBAFBC79A1DFB93F9891668F71C8B2D0D8B913FEA28CE1088C9F23E68EC02F4B28E0A8F5344106EEC9369F861BBCE965ACCB3905DFB62C50617AD2B6E;1524852989689,30819F300D06092A864886F70D010101050003818D0030818902818100873BADB1A8A78321302550D26FA4F80E56934B5903A1FD8C632C3B1FA77AB10B4DF5864F4CA56B1FA61CF3A9917AFD518D2BEF6BC14320972E8E56DCB58F8AE4E5C9A3B641DCEB17D219DE3A0E1827B62D6E919A85D8FC53C8FAB1CE159C0D7604C1B47898DC9D4D5DE016A6573E8446E6D6304FB8BF2BD11C119F53F80EFAEF0203010001,30819F300D06092A864886F70D010101050003818D00308189028181009B9DF71FE63D4CB7D7D7CF58E5821F0A98EAC28581B701FDAEBE0AD4CC647023BD3A68A0F7FBC05879A7DC2D5CCF4CA227A9066C347431ECF98621DA2ABDD05B6544ACE835A288EC2FE816A9DB71BFA0D5977789EBFABCF6CF33DF313DDB018E8418F8ECEC9021FBDE6200C2134239491DEB134BA845AC33D9E3FABE2467A8F10203010001,300.000000,72E5B827A36D539C1CEDAB374355E366EB808F219E65606592F4E6BDE68845A9,54ADEF1C127DE8168D0F100F86C59BE1DB3EBA51F54B89FB4C1D1FA2B414B770D322E0CE717961DE916BE03E6A064073C8AB8F3E58D6C3D597285B2CDA06E4D2080ABCB1B53D106696331748C461DBDBC31CBB99F203FE7E3A6EBE31E0D11959330097969236683F27BA65442BA68FD18011C8417C8108E3C8E4A3E082ECBAE7;1524852989691,30819F300D06092A864886F70D010101050003818D00308189028181009B9DF71FE63D4CB7D7D7CF58E5821F0A98EAC28581B701FDAEBE0AD4CC647023BD3A68A0F7FBC05879A7DC2D5CCF4CA227A9066C347431ECF98621DA2ABDD05B6544ACE835A288EC2FE816A9DB71BFA0D5977789EBFABCF6CF33DF313DDB018E8418F8ECEC9021FBDE6200C2134239491DEB134BA845AC33D9E3FABE2467A8F10203010001,30819F300D06092A864886F70D010101050003818D0030818902818100950C27E29EEF8CE356468C4250586E51B9A0EE23748706331812D1AC43F0EE74B6B711C40DC06D48FA181E97205E9758FE561ADA98823759270A27B368115774FFA78017C5F2FF0AD8E0D0132DA718CE7E6862F6F756F2C474575B8A3192A550E5E2BBD7278C7949610B1C9661BD9A4B3B535A2B0702567D7842C097C1C7E8D30203010001,200.000000,F5F6F45F4592A34847CC2E5C2134E7E1CB9D7A50EB6ED874F2D99BF1B3318951,0758D3B7AE2BD17428DA9BE322DD5E1BAEE4DCD8DA4CFFDE0D45BC74DCFFF633BADF4A56ED4057CD15B04B24B874FC189A4D2FF9D7E4040D65E5C89C9250471EFC3B5374A5E052FE32A0AAD82FD5837ECC7D1959EA8D40951F15648A8B4760A79E0EED0BEA9D7EBB0D869BB96D72219B3A0371C6AA7C15DB16A91805DAE35554;1524852989693,30819F300D06092A864886F70D010101050003818D0030818902818100950C27E29EEF8CE356468C4250586E51B9A0EE23748706331812D1AC43F0EE74B6B711C40DC06D48FA181E97205E9758FE561ADA98823759270A27B368115774FFA78017C5F2FF0AD8E0D0132DA718CE7E6862F6F756F2C474575B8A3192A550E5E2BBD7278C7949610B1C9661BD9A4B3B535A2B0702567D7842C097C1C7E8D30203010001,30819F300D06092A864886F70D010101050003818D003081890281810098EAE1162CBF8CADE3BD54084379C11601BE2EB8338DE4D2D99E6057499DA201FD4B468C86AE1901210306C670F36E1E63DCA9058221BFA11691BF8807BDE77D207C2200F65AEA57443F379FC359D9119C539C10D933D1C0886789422D25D99A4B1FFBBC0F650FDD2D4EAA721354E9A85B59B5AA636A8A471568F82F6F1E08F50203010001,100.000000,AD40E52CDDA5A19AD1453FE5FB8896C4A70AF1F4EB6C265B9C895EF06D5ECE15,2C1B07B398CBB2CCD752317BDA1F2ED2A7F66101DA7BC6416165CC96DC4EFB3D8CC4B2ED58E2F1715A2411902BC9E4E8102F71BDB151EC2EF5D77B3BF7805403CB9681B920773572387E01B3B53F392DBC854047DC72753270CACE25627C12583AD546018F5E8ED3132210E2172DC35F3B42FA10F5E192BDADA86E85F72BF940}";
    }

    @Test
    public void testCreateBlock() throws BlockFormatException {
        Block block = BlockFactory.create(null, messages);
        assertNotNull(block);
        assertNotNull(block.getHash());
        assertNotEquals(0, block.getTimestamp());
        assertNotNull(block.getNonce());
        assertNull(block.getPreviousHash());
        assertEquals(messages, block.getMessages());
        System.out.println(block.getStorageString());
    }

    @Test(expected = BlockFormatException.class)
    public void testCreateBlockEmptyMessagesThrowsError() throws BlockFormatException {
        BlockFactory.create("asd", new TreeSet<>());
    }

    @Test
    public void testParseBlock() throws MessageFormatException, BlockFormatException {
        Block block = BlockFactory.parse(blockString);
        assertNotNull(block);
        assertEquals("0000578EB0992ADCD8B3A688266248063D6DB39B3377E502D124DC1D6CFE8956", block.getHash());
        assertEquals(Long.parseLong("1524852989699"), block.getTimestamp());
        assertEquals("9261476567759882", block.getNonce());
        assertNull(block.getPreviousHash());
        assertEquals(messages.size(), block.getMessages().size());
        assertEquals(blockString, block.getStorageString());
    }
}
