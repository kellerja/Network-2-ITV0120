package network_applications_2.block;

import network_applications_2.message.Message;
import network_applications_2.message.MessageFactory;
import network_applications_2.message.MessageFormatException;
import network_applications_2.utilities.KeyGenerator;
import network_applications_2.utilities.KeyManager;
import org.junit.BeforeClass;
import org.junit.Test;

import java.security.KeyPair;
import java.util.*;

import static org.junit.Assert.*;

public class BlockFactoryTests {

    private static NavigableSet<Message> messages;
    private static List<KeyPair> users;
    private static String blockString;

    @BeforeClass
    public static void initialize() throws MessageFormatException {
        users = new ArrayList<>();
        for (int i = 0; i < 10; i++) {
            users.add(KeyGenerator.generate());
        }
        messages = new TreeSet<>();
        messages.add(MessageFactory.create(users.get(0), 1000));
        for (int i = 1; i < 10; i++) {
            messages.add(MessageFactory.create(users.get(i - 1),
                    KeyManager.convertToString(users.get(i).getPublic()),
                    1000 - 100 * i));
        }
        blockString = "1525428097292,null,0000C5D67934FB939D5568EEDE60D2AD2856291CA4EB8765029FDB2868FAC43C,654407921176727,{1525428097241,30819F300D06092A864886F70D010101050003818D0030818902818100E2D65FB648CB1716D3772FDA24C3ED276C35E92631CA8A2804192F946248725AA39E49EBB2B6C08306C503050D883C3352041E544B1FA00E95571498B335A2D0BB85C99245BD36367A93C08495EDD1180826C6A57E7345E1497D4A12E74CEBF576E524E429B91B4A38E42B4DF38D0631D14772A21246D5B471B6A5B287130E430203010001,1000.0,27377BFC827DA11316DE075EB179D6209902A4AFBACB83BE6F3A371CE5885060,5CB68D93398669837C9573A69C1B27CF2F5CC67FB4B653B231D5A96448912E10C48A59CBE2B9DDF759A113C485BEDE58F541AB22EA3374D28CDB599099EB6A5C6F1335E2DCCA73F3FF7F1D776591C8DDD5CE9DBAFB1427A5009127ED52723315FABC906AF61BB1AFAF2A29C9F81B53C59FAD6C717D618671D53901F883BF2386;1525428097251,30819F300D06092A864886F70D010101050003818D0030818902818100E2D65FB648CB1716D3772FDA24C3ED276C35E92631CA8A2804192F946248725AA39E49EBB2B6C08306C503050D883C3352041E544B1FA00E95571498B335A2D0BB85C99245BD36367A93C08495EDD1180826C6A57E7345E1497D4A12E74CEBF576E524E429B91B4A38E42B4DF38D0631D14772A21246D5B471B6A5B287130E430203010001,30819F300D06092A864886F70D010101050003818D003081890281810098DEBD0ACB087D0BA018B493A1B0C05FCDDA5805DF99D7707C9E677A2C282D668493C8136E0CDA62128A980B1C9B7C2F8926E55D086DFB7E768EEBE91F6BF6C218457CE8FD74ACF3F08861EAD581348F7FDDF99BB618AD11C2CED4F280182B0FF1ECEDBCD4C85A26B5ACCAB4424728B64C1303137EA5927F658F7215E623B7B50203010001,900.0,4D4744248CF477435DF5DA7D9B915A8443D8509F4B2194BCE355A79430536A1A,350847556DA79B97FD4074EDBBF93C23764DA6F38928755D4C9B0875C4965D4D12E74F556D06EAE710EB895EDF61FB2264AA2FAFC4B16960B6448DDE87540CCA266B969F9E488E6D45707A9A9B1DC94FEA10013BD622914AA5AC7BF6DA19C7AF26F9CDF67FE32198CD9D68E82A141440540AB434EA421D00E6CCC129F76C6A1F;1525428097254,30819F300D06092A864886F70D010101050003818D003081890281810098DEBD0ACB087D0BA018B493A1B0C05FCDDA5805DF99D7707C9E677A2C282D668493C8136E0CDA62128A980B1C9B7C2F8926E55D086DFB7E768EEBE91F6BF6C218457CE8FD74ACF3F08861EAD581348F7FDDF99BB618AD11C2CED4F280182B0FF1ECEDBCD4C85A26B5ACCAB4424728B64C1303137EA5927F658F7215E623B7B50203010001,30819F300D06092A864886F70D010101050003818D0030818902818100A3EA612AD092B92A578D5AA32629C220160EF9852932F86E36B5873A04B0A3C7A69ACB217DFD140B0C08EFCA978D6AD84666FE7B7EF77DCA3AAD2A970A60F7C3177725BB24B489C9C043DFB7EFB1CDA11C75455B06D56E2633AC920BB604FE1ADBEFDC562E931621AB7F4418E5AE8802E66AC7DCED6DCB3999FF362FE67854BD0203010001,800.0,01C758C969E901BB3855F5AB9A6DA116B5BFD4B66EFAF7EC9C0332E3D16BEC8D,6DE5D8B7FC5A32A771F0E8EDF10C6AFF35CB36E448CEB5802190E7C380063B0D6117E1A2B37EA46BFF0B185AA98CDED4B8F3E17BB34C5BFEBA365D7131DA39BD8499317DF82002F7A2EE6579DC4CA389BCF9AE884CFB9140BB200F7832CCC18A452B13F1DCFD98EB61AA05BA031FC4589272EA8F40C5C3027D18FCEA7FDB3368;1525428097256,30819F300D06092A864886F70D010101050003818D0030818902818100A3EA612AD092B92A578D5AA32629C220160EF9852932F86E36B5873A04B0A3C7A69ACB217DFD140B0C08EFCA978D6AD84666FE7B7EF77DCA3AAD2A970A60F7C3177725BB24B489C9C043DFB7EFB1CDA11C75455B06D56E2633AC920BB604FE1ADBEFDC562E931621AB7F4418E5AE8802E66AC7DCED6DCB3999FF362FE67854BD0203010001,30819F300D06092A864886F70D010101050003818D00308189028181009EECA35390E8FEDEFBCE97A5C6DC0F48216D973189EC5610FB7565462F480B6D534248B24BBA5ACD3E7A89F62379A6A8C0B20631864F15902E442D5336167C69F68B3B2D813A55A9DE711898AC571EAA5A65015722BD2F6B18CF4646AA89DDE4931B9620F8F7F453DC24F6E62A16577DEDBA41547298666D094F9BDA7B058D9D0203010001,700.0,05BCBF228F89D13DCE76EF8E607718ED4C959A987C0F889616D40C6D374B97D8,99AC48626D83EF14774B98D0BBF18C634B99B3985FDD216194343993CF69909FE42A86816139001E3E80CB9343346A12A56FF7E7AEC8CD9967BE15749717E8A79CD588886EC0D8CAE49EDF097AC49F20062E21C82171AC5842BC4A4D1FCA150DF6D95502F874AA94E4CFD434809670603EFA5C2C9749A19A55D18E198A81353F;1525428097259,30819F300D06092A864886F70D010101050003818D00308189028181009EECA35390E8FEDEFBCE97A5C6DC0F48216D973189EC5610FB7565462F480B6D534248B24BBA5ACD3E7A89F62379A6A8C0B20631864F15902E442D5336167C69F68B3B2D813A55A9DE711898AC571EAA5A65015722BD2F6B18CF4646AA89DDE4931B9620F8F7F453DC24F6E62A16577DEDBA41547298666D094F9BDA7B058D9D0203010001,30819F300D06092A864886F70D010101050003818D0030818902818100A9A9D6E2B624982D23488FEF58E91CE7F6DD75CE596B8009CF4694579DD934358C76523B2E3A4FE951074E29BD0241DE9BEB788354B40570D08165DE99C46CF5BBF992B0FE5DBAC271000F97A32576AE4A002746A3CC07FEB6062F59654BB1B7B4E38CA0765CA9B179BA26DCF973AD6929F5E3D45BF8FCB883F8EFD7A74DD5C30203010001,600.0,2465362B8EF530136517FC941B44C05FF666AA47B6989CBD5BFA4DE5ECBD88A5,1CB1A68F7B8120B354BE2BA04DA1B27F1C45B31AAE31ED8D3221087A14C6C5A4FF94DB33679606BBE053DD3DAD745CB53E56A512FE5DC34AE8BCB9A983E99FC31F12CE633A5C22A847022C5C81D663E8FBE6F69A72FE039947D75A355E668D6A698C5FB3866ED20530EF639ED81A88D52E4210DD79D6DE50586BF1D30E06AD83;1525428097261,30819F300D06092A864886F70D010101050003818D0030818902818100A9A9D6E2B624982D23488FEF58E91CE7F6DD75CE596B8009CF4694579DD934358C76523B2E3A4FE951074E29BD0241DE9BEB788354B40570D08165DE99C46CF5BBF992B0FE5DBAC271000F97A32576AE4A002746A3CC07FEB6062F59654BB1B7B4E38CA0765CA9B179BA26DCF973AD6929F5E3D45BF8FCB883F8EFD7A74DD5C30203010001,30819F300D06092A864886F70D010101050003818D0030818902818100A915E1BD113D8CA6B2EA9649845848AC296099F2FF2FFAD68C6AD4F2B39B37A4EA32E94AE2FABEFDFF22F6A5083A2ACB9455705B6F25646A65E969085AC936B520336E88DB1126CE9F1151EDE0569203E3A9F834F7C3D7C687EC5961D1D3090786FC0B4F93D17CF151319512045160BB77E76B4CF6DAE25FBF3CA1895E12F9FB0203010001,500.0,77E0E7220C423EEBCF993CD32A8F9C65737E41533D0BDDC05D902681F5A28A00,40C942CBEFBB62A7AE21C323F35B8CA08EB8CDE266422E782EE045C798C4977EA893B698A4C2708226079F4157175B5FC8F5BE2B7ABD6453DCF8DAA849CFD07073A26E5200231D46DCCE692DF1D791E62880F57FA967AF91266978C9BFE62BB73AA3CA8277EE0DB90036CADFABB5EE56BDE1FB1645907844BBCC64BC4D4BD05A;1525428097277,30819F300D06092A864886F70D010101050003818D0030818902818100A915E1BD113D8CA6B2EA9649845848AC296099F2FF2FFAD68C6AD4F2B39B37A4EA32E94AE2FABEFDFF22F6A5083A2ACB9455705B6F25646A65E969085AC936B520336E88DB1126CE9F1151EDE0569203E3A9F834F7C3D7C687EC5961D1D3090786FC0B4F93D17CF151319512045160BB77E76B4CF6DAE25FBF3CA1895E12F9FB0203010001,30819F300D06092A864886F70D010101050003818D0030818902818100BE2016929FF3CB96FD122D1B44212A9A096D31F455048244346E8742950A643D8F6250C5BAA30A5C633381F1B0D9FC3831F551EDBCA2E074081F5619E5FE92E8ED6475C7CC39FC296383A7FD96A0E63C8A83C348D494D8F0BAA7F1B2B8B37A74E59FE54343AE462DE21D80513F475118DFE0B6EA49ED6395926C842885D6DC010203010001,400.0,23A27C6793D3209528382E251E47154B600658D765CE26F982F00F0229141692,2CC52F016BDEAB5A32AF151593A4581473C1C620CA091DDEB01414DD9DD49D5BFD2479A5A81CA476D5809C1927C03688BBFCA320A279EA11CCD39BE83F87125E7E0CB58884179D44FC184C7B7E98ECD32E3EBAC99B3DF94DC26AEF34F5B8065BD00F87F437708F98E8E2AAAA0E873F7014FC6C353750B59EB3DC2842FC3A77D1;1525428097279,30819F300D06092A864886F70D010101050003818D0030818902818100BE2016929FF3CB96FD122D1B44212A9A096D31F455048244346E8742950A643D8F6250C5BAA30A5C633381F1B0D9FC3831F551EDBCA2E074081F5619E5FE92E8ED6475C7CC39FC296383A7FD96A0E63C8A83C348D494D8F0BAA7F1B2B8B37A74E59FE54343AE462DE21D80513F475118DFE0B6EA49ED6395926C842885D6DC010203010001,30819F300D06092A864886F70D010101050003818D0030818902818100DE9109D8D7C01434CF6F8AA88425A1F2F68347B2E760C8CD526F2AE301EDF592D306E4BBFE98BB43582A63CBEA62540EC2ABE6668275B45F1C81A783CFC43598D6564F0D0F12488A8EDFA81C09BC6878B5BA3D43FFEE736CE400AD7565D52DF9F4CB82FE92CB78FA84E2ADC553527C26C8E3FD54D4B44BD3038AD796607380E10203010001,300.0,A7E6E9E993E8905F508A83DFF0127A302AA7AAFBE289233AF3054126F76199EB,7BC19C77CB112C55D4C65E70B218AE43624C9732E99EFC46AFCBF48FCC5A9D13E725B33C456F93FB0917F2C3ACAD554A7A2C0A519F32EB5DD97E9178B14BB36B20BE372308CE3861C4AAEBC6651BEC14B9E823D222A3B29005A599B4A37BC00A0894F68BF15B9B01FAC8125EFED97649C52901663AF68F8902557E7F4BCF2CC7;1525428097283,30819F300D06092A864886F70D010101050003818D0030818902818100DE9109D8D7C01434CF6F8AA88425A1F2F68347B2E760C8CD526F2AE301EDF592D306E4BBFE98BB43582A63CBEA62540EC2ABE6668275B45F1C81A783CFC43598D6564F0D0F12488A8EDFA81C09BC6878B5BA3D43FFEE736CE400AD7565D52DF9F4CB82FE92CB78FA84E2ADC553527C26C8E3FD54D4B44BD3038AD796607380E10203010001,30819F300D06092A864886F70D010101050003818D00308189028181009D54787E7554EECCC40CCE7E6007CA20E2FB60D6C6D2F9271DA6E5810F14836FB7417BF4C51554BC448435654609938B350EC8030A2F572AB4C1B55C35AEE0C4C98A3DEDFEED2ED68B714A81225482FD97C5F23BCF230D1C2092B3280AFC77A40F7C8FA39FEC16E4976BFFFBB58A88067A31D620F97348D1399629FC4109FD150203010001,200.0,BC70E1EFCD2A76610693E47F37D10FA8CC080211D54EFD7936C335732C2C9B7A,C5932D77898D8B7398F3A0CCCEC65F84F2EE0AEA10A0F860254B988586271AF5DCAC31340943F9976B7E7E311643224D026F7920DE0A5856C47697340B69239030D83FC0E510CC2979108E5B9449ADD11E77A28D219EF53B3C764D2FD256FB1EEF0540EBF87EF63B569B7ECF9F7C2BC247F1CD49CD98869D4A590554A54F5C33;1525428097286,30819F300D06092A864886F70D010101050003818D00308189028181009D54787E7554EECCC40CCE7E6007CA20E2FB60D6C6D2F9271DA6E5810F14836FB7417BF4C51554BC448435654609938B350EC8030A2F572AB4C1B55C35AEE0C4C98A3DEDFEED2ED68B714A81225482FD97C5F23BCF230D1C2092B3280AFC77A40F7C8FA39FEC16E4976BFFFBB58A88067A31D620F97348D1399629FC4109FD150203010001,30819F300D06092A864886F70D010101050003818D0030818902818100BE8927102E8ECB83DD1B7D84B08CA089D9AB443AE48FFF46905212EFE7EB38C54D25562D3D97C5AE0CC450367CAA8FEDAC5E02DF8E966307D13653DE4C1C6A7D684B12CD67300B8891CC0F23862C3CA37FFE24FA703BD87D080D80FA278E5A2F49A74F7922C31BC78A09C408F823C252776A65FB65572087750D7E9BA114C78B0203010001,100.0,925E975FA8CD235F3E7394ACE19CD5A02B6A5D8207CFB342A3455847A9A40632,2CD01337A98E6D67897D56DB6158A45FFA2298FF30924A7121F037DE879EB144DB4D6CAF9D48917DA3674AFD969294D787DE152DA3ED6AD8209DD5D32EC34A7977BD556525EAB7F3E725DBC67EACACF06BAAF00CC75866707947B80B33201F5D712438901B56EE05F2C2A26B07571397DA98B84F863D6E02681DD9631994D4B9}";
    }

    @Test
    public void testCreateBlock() throws BlockFormatException {
        Block block = BlockFactory.create(null, messages);
        assertNotNull(block);
        assertNotNull(block.getHash());
        assertNotEquals(0, block.getTimestamp());
        assertNotNull(block.getNonce());
        assertNull(block.getPreviousHash());
        assertEquals(messages, block.getMessages());
        System.out.println(block.getStorageString());
    }

    @Test(expected = BlockFormatException.class)
    public void testCreateBlockEmptyMessagesThrowsError() throws BlockFormatException {
        BlockFactory.create("asd", new TreeSet<>());
    }

    @Test
    public void testParseBlock() throws MessageFormatException, BlockFormatException {
        Block block = BlockFactory.parse(blockString);
        assertNotNull(block);
        assertEquals("0000C5D67934FB939D5568EEDE60D2AD2856291CA4EB8765029FDB2868FAC43C", block.getHash());
        assertEquals(Long.parseLong("1525428097292"), block.getTimestamp());
        assertEquals("654407921176727", block.getNonce());
        assertNull(block.getPreviousHash());
        assertEquals(messages.size(), block.getMessages().size());
        assertEquals(blockString, block.getStorageString());
    }
}
